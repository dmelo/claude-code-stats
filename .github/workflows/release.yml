name: Build and Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build:
    name: Build macOS App
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build app
        run: |
          cd ClaudeCodeStats
          xcodebuild -project ClaudeCodeStats.xcodeproj \
            -scheme ClaudeCodeStats \
            -configuration Release \
            -derivedDataPath build \
            -arch arm64 -arch x86_64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Create ZIP archive
        run: |
          cd ClaudeCodeStats/build/Build/Products/Release
          zip -r ClaudeCodeStats-${{ github.ref_name }}.zip ClaudeCodeStats.app
          mv ClaudeCodeStats-${{ github.ref_name }}.zip ${{ github.workspace }}/

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: ClaudeCodeStats-${{ github.ref_name }}.zip

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA=$(shasum -a 256 ClaudeCodeStats-${{ github.ref_name }}.zip | awk '{print $1}')
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA"

      - name: Update Homebrew Tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Extract version without 'v' prefix
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"

          # Clone homebrew-tap
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/dmelo/homebrew-tap.git
          cd homebrew-tap

          # Update the cask formula
          cat > Casks/claude-code-stats.rb << EOF
          cask "claude-code-stats" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/dmelo/claude-code-stats/releases/download/v#{version}/ClaudeCodeStats-v#{version}.zip"
            name "Claude Code Stats"
            desc "Menu bar app displaying Claude Code usage limits"
            homepage "https://github.com/dmelo/claude-code-stats"

            app "ClaudeCodeStats.app"

            zap trash: [
              "~/Library/Preferences/com.claudecodestats.app.plist",
            ]
          end
          EOF

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/claude-code-stats.rb
          git commit -m "Update claude-code-stats to v${VERSION}"
          git push
